%%
%% Package fullwidth
%%
%% Currently the package has a beta-Status
%%
%% Copyright (c) 2010 Marco Daniel
%%
%% This package may be distributed under the terms of the LaTeX Project
%% Public License, as described in lppl.txt in the base LaTeX distribution.
%% Either version 1.0 or, at your option, any later version.


%% Allgemeine Angaben
\def\fwdversion{v0.1}
\def\fwdpackagename{fullwidth}
\def\fwddate{2011/11/18\space}
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{fullwidth}[\fwddate \fwdversion: \fwdpackagename]

%%Benoetigte Pakete
\RequirePackage{kvoptions}
\RequirePackage{etoolbox}
\RequirePackage{zref-abspage}
\SetupKeyvalOptions{family=fwd,prefix=fwd@}
%%Schleifenmakro zur Optioneneingabe
\DeclareListParser*{\fwd@dolist}{,}

%Laengenoptionen
\def\fwd@do@lengthoption#1{%
  \fwd@lengthoption@doubledo#1\@nil%
}
\def\fwd@lengthoption@doubledo#1==#2\@nil{%
  \csdef{#1}{}
  \expandafter\newlength\csname fwd@#1@length\endcsname%
  \expandafter\deflength\csname fwd@#1@length\endcsname{#2\relax}%
  \fdw@define@key@length{#1}%
}
\newrobustcmd*{\fdw@define@key@length}[1]{%
   \define@key{fwd}{#1}{%
      \expandafter\deflength\csname fwd@#1@length\endcsname{##1\relax}%
   }%
}

\fwd@dolist{\fwd@do@lengthoption}{%
   {width==\linewidth},%
   {skipabove==\z@},%
   {skipbelow==\z@},%
   {leftmargin==\z@},%
   {rightmargin==\z@},%
   {innertopmargin==0.4\baselineskip},%
   {innerbottommargin==0.4\baselineskip},%
   {splittopskip==\z@},%
   {splitbottomskip==\z@},%
   {outermargin==-999pt},%
   {innermargin==-999pt},%
   {footenotedistance==\medskipamount},
}

%Nutzung des Paketes needspace
\define@key{fwd}{needspace}[\z@]{%
     \begingroup%
        \setlength{\dimen@}{#1}%
        \vskip\z@\@plus\dimen@%
        \penalty -100\vskip\z@\@plus -\dimen@%
        \vskip\dimen@%
        \penalty 9999%
        \vskip -\dimen@%
        \vskip\z@skip % hide the previous |\vskip| from |\addvspace|
      \endgroup%
}

\DeclareBoolOption{nobreak}

\ProcessKeyvalOptions*\relax
\newrobustcmd{\fullwidthsetup}{\setkeys{fwd}}


%Anpassung lrbox
\let\fwd@lrbox\lrbox
\patchcmd\fwd@lrbox\hbox\vbox{}{}
\patchcmd\fwd@lrbox\color@setgroup{%
\color@setgroup%
\hsize=\fwd@width@length%
\columnwidth=\hsize%
\textwidth=\hsize%
\linewidth=\hsize%
}{}{}
\def\endfwd@lrbox{\unskip\color@endgroup}

%Anpassung trivlist
\let\fwd@trivlist\trivlist
\let\endfwd@trivlist\endtrivlist
\patchcmd\endmd@trivlist\@endparenv\fwd@endparenv{}{}
\def\fwd@endparenv{%
  \addpenalty\@endparpenalty\addvspace\fwd@skipbelow@length\@endpetrue}

\newrobustcmd*\fwd@makebox[2][\fwd@width@length]{%
 \noindent\makebox[#1][l]{#2}%
}


\newrobustcmd*\fwd@footnoterule{%
    \kern0\p@%
    \hrule \@width 1in \kern 2.6\p@}


\newrobustcmd*\fwd@footnoteoutput{%
     \ifvoid\@mpfootins\else
          \nobreak%
          \vskip\fwd@footenotedistance@length%
          \normalcolor%
          \fwd@footnoterule
          \unvbox\@mpfootins
     \fi%
}

\newrobustcmd*\md@footnoteinput{%
   \def\@mpfn{mpfootnote}%
   \def\thempfn{\thempfootnote}%
   \c@mpfootnote\z@%
   \let\@footnotetext\@mpfootnotetext%
}


\let\fwd@reserved@a\@empty
\newrobustcmd*\fwd@detect@output{%
  \iffwd@nobreak%Option nobreak=true?
        \def\fwd@reserved@a{\fwd@standalone}%
     \else
       \def\fwd@reserved@a{\fwd@output}%
       \ifnum\@floatpenalty<0\relax%Detecting float
          \if@twocolumn%
             \ifx\@captype\@undefined
                 \def\fwd@reserved@a{\fwd@output}%
             \else
                 \PackageWarning{fullwidth}{fullwidth inside float  ^^J
                                 fullwidth uses option nobreak}%
                 \def\fwd@reserved@a{\fwd@standalone}%   
             \fi
          \else
             \PackageWarning{fullwidth inside float  ^^J
                             fullwidth uses option nobreak}%
             \def\fwd@reserved@a{\fwd@standalone}%     
          \fi%
       \fi%
       \if@minipage%
             \PackageWarning{fullwidth inside minipage  ^^J
                             fullwidth uses option nobreak}%
             \def\fwd@reserved@a{\fwd@standalone}%
       \fi%
       \ifinner%
            \PackageWarning{fullwidth inside a box ^^J
                            fullwidth uses option nobreak }%
             \def\fwd@reserved@a{\fwd@standalone}%
      \fi%
  \fi%
\fwd@reserved@a%
}

\newenvironment{fullwidth}[1][]{%
  \begingroup
  \fullwidthsetup{#1}%%
   \fwd@twoside@checklength%
   \let\width\z@%
   \let\height\z@%
   \setlength{\topsep}{\fwd@skipabove@length}%
   \begingroup%
     \let\partopsep\z@%
   \expandafter\endgroup%   
   \begin{fwd@trivlist}\item\relax%
   \fwd@horizontalmargin@equation%
   \fwd@footnoteinput%
   \begin{fwd@lrbox}{\@tempboxa}%
 }{
   \ifmdf@footnoteinside%
      \def\fwd@reserveda{%
        \fwd@footnoteoutput%
        \end{fwd@lrbox}%
        \let\hsize\linewidth
        \fwd@detect@output}%
    \else%
      \def\fwd@reserveda{%
        \end{fwd@lrbox}
        \let\hsize\linewidth
        \fwd@detect@output%
        \fwd@footnoteoutput%
        }%
    \fi%
    \fwd@reserveda%
    \end{fwd@trivlist}%
    \hrule \@height\z@ \@width\hsize
\endgroup\@endparenv%
}



%%==================================================%%
%%================== Twoside-Modus =================%%
%%==================================================%%
\newtoggle{fwd:checktwoside}
\settoggle{fwd:checktwoside}{false}
\newrobustcmd*\fwd@twoside@checklength{%
 \if@twoside
   \ifboolexpr{ test {\ifdimequal{\fwd@outermargin@length}{-999pt}}
               and
               test {\ifdimequal{\fwd@innermargin@length}{-999pt}}
              }%
              {%
              \PackageInfo{fullwidth}{You haven't set the outermargin/innermargin^^
                                 mdframed will use leftmargin/rightmargin}%
              \settoggle{fwd:checktwoside}{false}%
              }%
              {\settoggle{fwd:checktwoside}{true}}%
   \iftoggle{fwd:checktwoside}{%
      \ifdimequal{\fwd@outermargin@length}{-999pt}%
         {\setlength\fwd@rightmargin@length{\z@}}%
         {\setlength\fwd@rightmargin@length{\fwd@outermargin@length}}%
     \ifdimequal{\fwd@innermargin@length}{-999pt}%
         {\setlength\fwd@leftmargin@length{\z@}}%
         {\setlength\fwd@leftmargin@length{\fwd@innermargin@length}}%
   }{}%
 \fi%
}

\newcounter{fwd@zref@counter}%keine doppelten laebes
\zref@newprop*{fwd@pagevalue}[0]{\number\value{page}}
\zref@addprop{\ZREF@mainlist}{fwd@pagevalue}

\newrobustcmd*\fwd@zref@label{%
   \stepcounter{fwd@zref@counter}
   \zref@label{fwd@pagelabel-\number\value{fwd@zref@counter}}%
}

\newrobustcmd*\if@fwd@pageodd{%
     \zref@refused{fwd@pagelabel-\the\value{fwd@zref@counter}}%
     \ifodd\zref@extract{fwd@pagelabel-\the\value{fwd@zref@counter}}{fwd@pagevalue}%
         \edef\fwd@reserveda{\fwd@pageisodd}%
     \else
        \edef\fwd@reserveda{\fwd@pageiseven}%
     \fi
     \fwd@reserveda%
}

\newrobustcmd*\fwd@pageisodd{%
      \ifdimequal{\fwd@outermargin@length}{-999pt}%
         {\setlength\fwd@rightmargin@length{\z@}}%
         {\setlength\fwd@rightmargin@length{\fwd@outermargin@length}}%
     \ifdimequal{\fwd@innermargin@length}{-999pt}%
         {\setlength\fwd@leftmargin@length{\z@}}%
         {\setlength\fwd@leftmargin@length{\fwd@innermargin@length}}%
}
\newrobustcmd*\fwd@pageiseven{%
      \ifdimequal{\fwd@outermargin@length}{-999pt}%
         {\setlength\fwd@leftmargin@length{\z@}}%
         {\setlength\fwd@leftmargin@length{\fwd@outermargin@length}}%
     \ifdimequal{\fwd@innermargin@length}{-999pt}%
         {\setlength\fwd@rightmargin@length{\z@}}%
         {\setlength\fwd@rightmargin@length{\fwd@innermargin@length}}%
}

\newrobustcmd*\fwd@@setzref{\fwd@zref@label\if@fwd@pageodd}

%%==================================================%%
%%================= Platz auf Seite ================%%
%%==================================================%%
\newrobustcmd*\fwd@freepagevspace{%
     \penalty\@M \vskip 2\baselineskip \vskip\height
     \penalty9999 \vskip -2\baselineskip \vskip-\height
     \penalty9999
     \ifdimequal{\pagegoal}{\maxdimen}%
          {\fwd@freevspace@length\vsize}%
          {\fwd@freevspace@length=\pagegoal\relax%
           \advance\fwd@freevspace@length by -\pagetotal\relax%
          }%
}

%%==================================================%%
%================= Breite der Box =================%%
%%==================================================%%
\newrobustcmd*\md@advancelength@orizontalmargin@add[1]{%
  \advance\md@horizontalspaceofbox by -\csname mdf@#1@length\endcsname\relax%
}

\newlength\fwd@horizontalspaceofbox
\newrobustcmd*\fwd@horizontalmargin@equation{%
    \setlength{\fwd@horizontalspaceofbox}{\fwd@width@length}%
    \ifdimless{\md@horizontalspaceofbox}{3cm}{\PackageWarning{You have only a width of 3cm\MessageBreak}}{}%
    \ifdimless{\pagewidth}{\md@horizontalspaceofbox}{\PackageWarning{You have a width larger than pagesize 3cm\MessageBreak}}{}%
    \hsize=\fwd@horizontalspaceofbox%
}

%%==================================================%%
%%===========Additionsalgorithmus fuer for==========%%
%%==================================================%%
\newrobustcmd*\md@advancelength@verticalmarginwhole[1]{%
  \advance\md@verticalmarginwhole@length by \csname mdf@#1@length\endcsname\relax%
}

\newrobustcmd*\md@advancelength@freevspace@sub[1]{%
  \advance\dimen@ by -\csname mdf@#1@length\endcsname\relax%
}

\newrobustcmd*\md@advancelength@freevspace@add[1]{%
  \advance\dimen@ by \csname mdf@#1@length\endcsname\relax%
}
%%==================================================%%
%%====================Reset changes=================%%
%%==================================================%%
\protected@edef\fwd@reset{\boxmaxdepth\the\boxmaxdepth 
                          \splittopskip\the\splittopskip}%


%%==================================================%%
%%===========Ausgaberoutine -> Berechnung===========%%
%%==================================================%%

\newrobustcmd*\md@put@frame@standalone{\relax%
   \ifvoid\@tempboxa\relax
      \md@PackageWarning{The environment is empty\MessageBreak}%
      \let\md@reserved@a\relax%
   \else
      %Hier berechnung Box-Inhalt+Rahmen oben und unten
      \setlength{\md@verticalmarginwhole@length}{\dimexpr\ht\@tempboxa+\dp\@tempboxa\relax}%
      \mdf@dolist{\md@advancelength@verticalmarginwhole}{%
                  outerlinewidth,middlelinewidth,innerlinewidth,innertopmargin,
                  innerbottommargin,innerlinewidth,middlelinewidth,outerlinewidth}%
      \md@keeplines@single%
      \def\md@reserved@a{\md@putbox@single}%
   \fi
   \md@reserved@a%
}


\def\md@put@frame{\relax%
\ifvoid\@tempboxa\relax
\md@PackageWarning{The environment is empty\MessageBreak}%
\let\md@reserved@a\relax%
\else
   \md@print@space%
   \md@freepagevspace%
   \md@PackageInfoSpace{\the\md@freevspace@length before the beginning of the environment^^J
                        ending on input line \MessageBreak}%
   \ifdimless{\md@freevspace@length}{2\baselineskip}
             {\md@PackageInfo{Not enough space on this page}%die Seite hat nur noch minimal Platz
              \vfill\eject%
              \def\md@reserved@a{\md@put@frame}%
             }{%
               %Hier berechnung Box-Inhalt+Rahmen oben und unten
              \setlength{\md@verticalmarginwhole@length}{\dimexpr\ht\@tempboxa+\dp\@tempboxa\relax}%
              \mdf@dolist{\md@advancelength@verticalmarginwhole}{%
                     outerlinewidth,middlelinewidth,innerlinewidth,innertopmargin,
                     innerbottommargin,innerlinewidth,middlelinewidth,outerlinewidth}%
             \md@keeplines@single%
             \ifdimless{\md@verticalmarginwhole@length}{\md@freevspace@length}%
                {%passt auf Seite%
                  \begingroup
                   \iftoggle{md:checktwoside}{\md@@setzref}{}%
                    \md@putbox@single%%passt auf Seite
                  \endgroup
                 \let\md@reserved@a\relax}%
                {\def\md@reserved@a{\md@put@frame@i}}%passt nicht auf Seite
             }%
\fi
\md@reserved@a%
}

\def\md@put@frame@i{%Box muss gesplittet werden -- Ausgabe der ersten Teilbox
      %Berechnung der Splittgroesse -- Linien und Abstand oben
      \md@freepagevspace%
      \dimen@=\the\md@freevspace@length%
      \dimen@i=\mdf@innertopmargin@length%
      \advance\dimen@i by \mdf@linewidth@length%
      \advance\dimen@i by 2\baselineskip%
      \ifdim\dimen@<\dimen@i\relax
           \hrule \@height\z@ \@width\hsize%
           \vfill\eject%
           \def\md@reserved@a{\md@put@frame}%
      \else%
      \mdf@dolist{\md@advancelength@freevspace@sub}{%
                outerlinewidth,middlelinewidth,innerlinewidth,%
                innertopmargin,splitbottomskip}%
      \ifbool{mdf@topline}{}{\advance\dimen@ by \mdf@middlelinewidth@length}%
      \ifdimless{\ht\@tempboxa+\dp\@tempboxa}{\dimen@}%
         {\md@PackageWarning{You got a bad break\MessageBreak
                             you have to change it manually\MessageBreak
                             by changing the text, the space\MessageBreak
                             or something else}%
          \advance\dimen@ by -1.8\baselineskip\relax%
         }{}%
         \advance\dimen@ by -1pt\relax%Box darf nicht zu Groß werden.
         \splitmaxdepth\z@ \splittopskip\mdf@splittopskip@length%
         \setbox\tw@\vsplit\@tempboxa to \dimen@
         \setbox\tw@\vbox{\unvbox\tw@}%needed?
         \ifdimgreater{\ht\tw@+\dp\tw@}{\dimen@}{%Falsch gesplittet
            \md@PackageInfo{Box was splittet wrong\MessageBreak}%
             \dimen@i=\dimen@
              \advance\dimen@ by -\ht\tw@
              \advance\dimen@ by -\dp\tw@
              \advance\dimen@i by 0.5\dimen@
             \splittopskip\z@%
             \setbox\@tempboxa\vbox{\unvbox\tw@%
                                     \hrule \@height\dp\strutbox \@width\z@%benoetigt um Tiefe zu haben
                                     \unvbox\@tempboxa}
             \splittopskip\mdf@splittopskip@length%
             \setbox\tw@\vsplit\@tempboxa to \dimen@i
             \setbox\tw@\vbox{\unvbox\tw@}%
             }{}%
         \setbox\@tempboxa\vbox{\unvbox\@tempboxa}%PRUEFEN!!!!
         \ifvoid\@tempboxa
           \md@PackageWarning{You got a bad break\MessageBreak
                               because the splittet box is empty\MessageBreak
                               You have to change the page settings\MessageBreak
                               like enlargethispage or something else}%
           \setbox\@tempboxa\vbox{\box\tw@\box\@tempboxa}%
           \def\md@reserved@a{\md@put@frame}%
         \fi
         \ifvoid\tw@%%pruefe, ob erste Box leer ist
          \hrule \@height\z@ \@width\hsize
          \vfill\eject%  
             \def\md@reserved@a{\md@put@frame}%
         \else
          \ifdimequal{\ht\tw@}{0pt}%
            {\hrule \@height\z@ \@width\hsize%
             \vfill\eject%
             \setbox\@tempboxa\vbox{\unvbox\tw@\unvbox\@tempboxa}
             \def\md@reserved@a{\md@put@frame}%
            }%
            {%
            \begingroup
               \iftoggle{md:checktwoside}{\md@@setzref}{}%
               \md@putbox@first%%%Groesse des Splittens passt
            \endgroup
            \hrule \@height\z@ \@width\hsize
            \vfill\eject%
            \def\md@reserved@a{\md@put@frame@ii}%
            }%
         \fi% 
      \fi%
\md@reserved@a%
}

\def\md@put@frame@ii{%Ausgabe der mittleren Box(en) wenn vorhanden
  \setlength{\md@freevspace@length}{\vsize}%
  \setlength{\dimen@}{\dimexpr\ht\@tempboxa+\dp\@tempboxa\relax}%
  \mdf@dolist{\md@advancelength@freevspace@add}{%
                outerlinewidth,middlelinewidth,innerlinewidth,%
                innerbottommargin}%%%Addition der Linien unten
   \ifbool{mdf@bottomline}{}{\advance\dimen@ by -\mdf@middlelinewidth@length\relax}%
   \ifdimgreater{\dimen@}{\md@freevspace@length}%
    {%
        \advance\md@freevspace@length by -\mdf@splitbottomskip@length
        \splitmaxdepth\z@ \splittopskip\mdf@splittopskip@length%
        \setbox\tw@\vsplit\@tempboxa to \md@freevspace@length%
        \setbox\tw@\vbox{\unvbox\tw@}%PRUEFEN!!!
        \setbox\@tempboxa\vbox{\unvbox\@tempboxa}%PRUEFEN!!!!
        \ifvoid\@tempboxa\relax%
           \md@PackageWarning{You got a bad break\MessageBreak
                               because the split box is empty\MessageBreak
                               You have to change the settings}%
         \fi%
        \begingroup
           \iftoggle{md:checktwoside}{\md@@setzref}{}%
           \md@putbox@middle%
        \endgroup
        \hrule \@height\z@ \@width\hsize
        \vfill\eject
        \def\md@reserved@a{\md@put@frame@ii}%
     }%Hier die Ausgabe der mittleren Box
     {\ifvoid\@tempboxa
           \md@PackageWarning{You got a bad break\MessageBreak
                               because the last split box is empty\MessageBreak
                               You have to change the settings}%
      \fi%
      \begingroup
          \iftoggle{md:checktwoside}{\md@@setzref}{}%
          \md@putbox@second%
      \endgroup
      \let\md@reserved@a\relax%
     }%Hier kommt die Ausgabe der letzten Box
  \md@reserved@a%
}

\endinput
